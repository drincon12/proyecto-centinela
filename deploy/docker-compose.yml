version: "3.9"

services:

#Frontend

  frontend:
    build: ../frontend
    container_name: centinela-frontend
    ports:
      - "80:80"
    depends_on:
      - backend

#backend API Gateway
  backend-api:
    build: ../backend-api
    container_name: backend-api
    ports:
      - "8000:8000"
    environment:
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_QUEUE=scraping_requests
      - ANALYSIS_HOST=analysis-service
      - ANALYSIS_PORT=9000
      - DB_HOST=db
      - DB_USER=centinela
      - DB_PASSWORD=centinela
      - DB_NAME=centinela
    depends_on:
      - rabbitmq
      - db
      - analysis-service

# Servicio Scraping
  scraping-service:
    build: ../scraping-service
    container_name: scraping-service
    environment:
      - RABBITMQ_HOST=rabbitmq
    depends_on:
      - rabbitmq

  # Servicio analysis-service
  analysis-service:
    build: ../analysis-service
    container_name: analysis-service
    environment:
      - DB_HOST=db
      - DB_PORT=5432
      - DB_USER=centinela
      - DB_PASSWORD=centinela
      - DB_NAME=centinela
    depends_on:
      - rabbitmq
      - db
    ports:
      - "9000:9000" # para pruebas desde el host, se vea http://analysis-service:9000

  # Servicio publishing-service 
  publishing-service:
    build: ../publishing-service
    container_name: publishing-service
    depends_on:
      - rabbitmq
      - db

# Base de datos PostgreSQL
  db:
    image: postgres:15
    container_name: centinela-db
    environment:
      - POSTGRES_USER=centinela
      - POSTGRES_PASSWORD=centinela
      - POSTGRES_DB=centinela
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data

# Servicio de RabbitMQ
  rabbitmq:
    image: rabbitmq:3-management
    container_name: centinela-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"

volumes:
  db_data:
# Prometheus para realizar m√©tricas
  prometheus:
    image: prom/prometheus:v2.54.0
    container_name: centinela-prometheus
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
    ports:
      - "9090:9090"
    depends_on:
      - backend-api

# Grafana para dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: centinela-grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana:/etc/grafana
    ports:
      - "3001:3000"
    depends_on:
      - prometheus
# Loki para registro de logs
 # loki:
 #   image: grafana/loki:latest
 #   container_name: centinela-loki
 #   volumes:
 #     - ./monitoring/loki/loki-config.yml:/etc/loki/local-config.yaml
 #     - loki_data:/loki
 #   ports:
 #     - "3100:3100"
 #   command: -config.file=/etc/loki/local-config.yaml
         
